name: pr

on:
  pull_request:
    branches: [main]

env:
  BRANCH_NAME: ${{ github.event.pull_request.head.ref }}

jobs:
  quality_checks:
    uses: ./.github/workflows/quality_checks.yml

  get_deployed_tags:
    runs-on: ubuntu-latest
    needs: quality_checks
    permissions:
      id-token: write
      contents: read
    outputs:
      account_resources_tag: ${{steps.output_account_resources_tag.outputs.account_resources_tag}}
      ci_resources_tag: ${{steps.output_ci_resources_tag.outputs.ci_resources_tag}}
    steps:
      - name: connect to dev account
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: eu-west-2
          role-to-assume: ${{ secrets.DEV_CLOUD_FORMATION_CHECK_VERSION_ROLE }}
          role-session-name: github-actions
      - id: output_account_resources_tag
        shell: bash
        run: |
          export current_deployed_account_resources_tag=$(aws cloudformation describe-stacks --stack-name account-resources --query "Stacks[0].Tags[?Key=='version'].Value" --output text)

          if [ "${current_deployed_account_resources_tag}" == "" ]; then
            echo "Can not find target tag. Using initial tag in repo"
            export current_deployed_account_resources_tag="v1.0.4-alpha"
          fi
          echo "account_resources_tag=${current_deployed_account_resources_tag}" >> "$GITHUB_OUTPUT"
      - id: output_ci_resources_tag
        shell: bash
        run: |
          export current_deployed_ci_resources_tag=$(aws cloudformation describe-stacks --stack-name ci-resources --query "Stacks[0].Tags[?Key=='version'].Value" --output text)
          if [ "${current_deployed_ci_resources_tag}" == "" ]; then
            echo "Can not find target tag. Using initial tag in repo"
            export current_deployed_ci_resources_tag="v1.0.4-alpha"
          fi
          echo "ci_resources_tag=${current_deployed_ci_resources_tag}" >> "$GITHUB_OUTPUT"

  list_ci_resources_cf_changes:
    needs: get_deployed_tags
    uses: ./.github/workflows/cloudformation.yml
    with:
      target_environment: dev-ci
      version: v1.0.18-alpha
      change_set_version: pr-${{github.event.number}}
      stack_name: ci-resources
      template: ./cloudformation/ci_resources.yml
      capabilities: CAPABILITY_IAM
      execute_change_set: false
    secrets:
      cf_create_changeset_role: ${{ secrets.DEV_CLOUD_FORMATION_CREATE_CHANGESET_ROLE }}
  
  list_account_resources_cf_changes:
    needs: get_deployed_tags
    uses: ./.github/workflows/cloudformation.yml
    with:
      target_environment: dev-account
      version: v1.0.18-alpha
      change_set_version: pr-${{github.event.number}}
      stack_name: account-resources
      template: ./cloudformation/account_resources.yml
      capabilities: CAPABILITY_IAM
      execute_change_set: false
    secrets:
      cf_create_changeset_role: ${{ secrets.DEV_CLOUD_FORMATION_CREATE_CHANGESET_ROLE }}
      
