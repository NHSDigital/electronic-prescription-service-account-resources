name: pr

on:
  pull_request:
    branches: [main]

env:
  BRANCH_NAME: ${{ github.event.pull_request.head.ref }}

jobs:
  quality_checks:
    uses: ./.github/workflows/quality_checks.yml

  package_code:
    needs: quality_checks
    uses: ./.github/workflows/package_code.yml

  list_ci_resources_cf_changes:
    needs: package_code
    uses: ./.github/workflows/cloudformation.yml
    with:
      target_environment: dev-ci
      version: pr-${{github.event.number}}
      change_set_version: pr-${{github.event.number}}
      stack_name: ci-resources
      template: ./cloudformation/ci_resources.yml
      capabilities: CAPABILITY_IAM
      execute_change_set: false
    secrets:
      parameter_secrets: "{}"
      cf_create_changeset_role: ${{ secrets.DEV_CLOUD_FORMATION_CREATE_CHANGESET_ROLE }}
  
  list_account_resources_cf_changes:
    needs: package_code
    uses: ./.github/workflows/cloudformation.yml
    with:
      target_environment: dev-account
      version: pr-${{github.event.number}}
      change_set_version: pr-${{github.event.number}}
      stack_name: account-resources
      template: ./cloudformation/account_resources.yml
      capabilities: CAPABILITY_IAM
      execute_change_set: false
    secrets:
      parameter_secrets: "{}"
      cf_create_changeset_role: ${{ secrets.DEV_CLOUD_FORMATION_CREATE_CHANGESET_ROLE }}
      
  list_lambda_resources_cf_changes:
    needs: package_code
    uses: ./.github/workflows/cloudformation.yml
    with:
      target_environment: dev-account
      version: pr-${{github.event.number}}
      change_set_version: pr-${{github.event.number}}
      stack_name: lambda-resources
      template: ./cloudformation/lambda_resources.yml
      capabilities: CAPABILITY_IAM
      execute_change_set: false
    secrets:
      parameter_secrets: '{"splunk_hec_token": "${{ secrets.DEV_SPLUNK_HEC_TOKEN }}", "splunk_hec_endpoint": "${{ secrets.DEV_SPLUNK_HEC_ENDPOINT }}"}'
      cf_create_changeset_role: ${{ secrets.DEV_CLOUD_FORMATION_CREATE_CHANGESET_ROLE }}
