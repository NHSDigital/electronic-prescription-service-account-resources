AWSTemplateFormatVersion: "2010-09-09"
Parameters:
  DeploySubjectClaimFilters:
    Type: CommaDelimitedList
    Description: >
      Subject claim filter for valid tokens for the deploy role.
    Default: ""
  CheckVersionSubjectClaimFilters:
    Type: CommaDelimitedList
    Description: >
      Subject claim filter for valid tokens for the check version role.
    Default: ""
  ReleaseNotesExecuteLambdaClaimFilters:
    Type: CommaDelimitedList
    Description: >
      Subject claim filter for valid tokens for the release notes execute lambda role.
    Default: ""
  PrepareChangesetClaimFilters:
    Type: CommaDelimitedList
    Description: >
      Subject claim filter for valid tokens for the prepare changeset role.
    Default: ""
  ArtilleryLoadTestRoleClaimFilters:
    Type: CommaDelimitedList
    Description: >
      Subject claim filter for valid tokens for the artillery load test role.
    Default: ""

Resources:
  ##################################################
  # Identity Provider
  ##################################################
  GitHubIdentityProvider:
    Type: AWS::IAM::OIDCProvider
    Properties:
      Url: https://token.actions.githubusercontent.com
      ThumbprintList:
        - 6938fd4d98bab03faadb97b34396831e3780aea1
      ClientIdList:
        - sts.amazonaws.com

  AllowOpenIDProviderPermissionsPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Roles:
        - Ref: CloudFormationDeployRole
        - Ref: CloudFormationCheckVersionRole
        - Ref: ReleaseNotesExecuteLambdaRole
        - Ref: CloudFormationPrepareChangesetRole
        - Ref: ArtilleryRunnerRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - iam:GetOpenIDConnectProvider
            Resource: "*"

  ##################################################
  # Cloudformation Deployment Role
  ##################################################
  # see https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect
  # for details about subject claim filters that are used for each role
  CloudFormationDeployRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Action:
              - sts:AssumeRoleWithWebIdentity
            Principal:
              Federated: !GetAtt GitHubIdentityProvider.Arn
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: sts.amazonaws.com
              ForAnyValue:StringLike:
                token.actions.githubusercontent.com:sub: !Ref DeploySubjectClaimFilters

  CreateCloudFormationStackPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Roles:
        - Ref: CloudFormationDeployRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - cloudformation:CreateStack
              - cloudformation:UpdateStack
              - cloudformation:DeleteStack
              - cloudformation:DescribeStacks
              - cloudformation:ListExports
              - cloudformation:CreateChangeSet
              - cloudformation:DescribeChangeSet
              - cloudformation:ExecuteChangeSet
              - cloudformation:DescribeStackEvents
              - cloudformation:GetTemplateSummary
              - cloudformation:ListStacks
              - cloudformation:DeleteChangeSet
            Resource: "*"

  AllowCloudFormationSecretsAccessManagedPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Roles:
        - Ref: CloudFormationDeployRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource:
              - !ImportValue account-resources:ProxgenPrivateKey
              - !ImportValue account-resources:ProxgenPublicKey
              - !ImportValue account-resources:PsuClientKeySecret
              - !ImportValue account-resources:PsuClientSandboxKeySecret
              - !ImportValue account-resources:PsuCACertSecret
              - !ImportValue account-resources:PsuCAKeySecret
              - !ImportValue account-resources:PsuClientCertSecret
              - !ImportValue account-resources:PsuClientSandboxCertSecret
              - !ImportValue account-resources:PSUProxygenPrivateKey
              - !ImportValue account-resources:PSUProxygenPublicKey
              - !ImportValue account-resources:CPSUProxygenPrivateKey
              - !ImportValue account-resources:CPSUProxygenPublicKey
          - Effect: Allow
            Action:
              - kms:Decrypt
            Resource:
              - !Sub "arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/*"

  ##################################################
  # Cloudformation Execution Role
  ##################################################
  CloudFormationExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - cloudformation.amazonaws.com
            Action:
              - sts:AssumeRole

  AssumeExecutionRolePolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Roles:
        - Ref: CloudFormationDeployRole
        - Ref: CloudFormationPrepareChangesetRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - iam:PassRole
            Resource: !GetAtt CloudFormationExecutionRole.Arn
  
  # Handy reference for AWS permissions:
  # https://docs.aws.amazon.com/service-authorization/latest/reference/reference_policies_actions-resources-contextkeys.html
  # 
  # to see what failed you can use this cloudwatch query against the NHSDAudit_trail_log_group
  # 
  # fields @timestamp, @message, @logStream, @log
  # | filter @message  like 'ci-resources-CloudFormationExecutionRole'
  # | filter @message like 'AccessDenied'
  # | sort @timestamp desc
  # | limit 1000
  # | fields eventSource, eventName
  # | display eventSource, eventName
  # | dedup eventSource, eventName
  #

  # there are multiple policies to prevent each one becoming too large

  # iam permissions are restricted to just act on this account so are in a separate policy
  GrantCloudFormationExecutionAccessIAMPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Roles:
        - Ref: CloudFormationExecutionRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - iam:AddClientIDToOpenIDConnectProvider
              - iam:Attach*
              - iam:Create*
              - iam:Delete*
              - iam:Detach*
              - iam:Get*
              - iam:List*
              - iam:Put*
              - iam:Remove*
              - iam:Tag*
              - iam:Untag*
              - iam:Update*
              - iam:PassRole
            Resource: !Sub "arn:aws:iam::${AWS::AccountId}:*"

  GrantCloudFormationExecutionAccessPolicyA:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Roles:
        - Ref: CloudFormationExecutionRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - cloudformation:CreateChangeSet
              - logs:AssociateKmsKey
              - logs:DisassociateKmsKey
              - logs:CreateLogGroup
              - logs:DeleteLogGroup
              - logs:TagLogGroup
              - logs:CreateLogStream
              - logs:DeleteLogStream
              - logs:PutRetentionPolicy
              - logs:DeleteRetentionPolicy
              - logs:PutSubscriptionFilter
              - logs:DescribeSubscriptionFilters
              - logs:DeleteSubscriptionFilter
              - logs:DescribeLogGroups
              - logs:CreateLogDelivery
              - logs:DeleteLogDelivery
              - logs:ListLogDeliveries
              - logs:GetLogDelivery
              - logs:UpdateLogDelivery
              - logs:ListTagsLogGroup
              - logs:UntagLogGroup
              - logs:ListTagsForResource
              - logs:TagResource
              - logs:DescribeLogStreams
              - logs:DescribeResourcePolicies
              - lambda:Add*
              - lambda:CreateFunction
              - lambda:CreateAlias
              - lambda:Delete*
              - lambda:Get*
              - lambda:List*
              - lambda:Publish*
              - lambda:Put*
              - lambda:Remove*
              - lambda:Tag*
              - lambda:Untag*
              - lambda:Update*
              - kms:Create*
              - kms:Delete*
              - kms:Describe*
              - kms:EnableKeyRotation
              - kms:Get*
              - kms:List*
              - kms:Put*
              - kms:ScheduleKeyDeletion*
              - kms:Tag*
              - kms:Untag*
              - kms:Update*
              - apigateway:DELETE
              - apigateway:GET
              - apigateway:POST
              - apigateway:PATCH
              - apigateway:PUT
              - apigateway:AddCertificateToDomain
              - apigateway:RemoveCertificateFromDomain
              - apigateway:UpdateRestApiPolicy
              - apigateway:TagResource
            Resource: "*"
  
  GrantCloudFormationExecutionAccessPolicyB:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Roles:
        - Ref: CloudFormationExecutionRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - s3:CreateBucket
              - s3:DeleteBucket
              - s3:PutBucketAcl
              - s3:PutEncryptionConfiguration
              - s3:PutBucketVersioning
              - s3:GetBucketTagging
              - s3:PutBucketTagging
              - s3:GetBucketPolicy
              - s3:PutBucketPolicy
              - s3:PutBucketLogging
              - s3:DeleteBucketPolicy
              - s3:PutBucketPublicAccessBlock
              - s3:GetReplicationConfiguration
              - s3:GetBucketOwnershipControls
              - s3:GetBucketPublicAccessBlock
              - s3:GetEncryptionConfiguration
              - s3:GetAccelerateConfiguration
              - s3:GetAnalyticsConfiguration
              - s3:GetLifecycleConfiguration
              - s3:GetMetricsConfiguration
              - s3:GetInventoryConfiguration
              - s3:GetIntelligentTieringConfiguration
              - s3:GetBucketCors
              - s3:GetBucketLogging
              - s3:GetBucketNotification
              - s3:GetBucketObjectLockConfiguration
              - s3:GetBucketVersioning
              - s3:GetBucketWebsite
              - firehose:CreateDeliveryStream
              - firehose:DescribeDeliveryStream
              - firehose:DeleteDeliveryStream
              - firehose:UpdateDestination
              - firehose:ListTagsForDeliveryStream
              - firehose:TagDeliveryStream
              - firehose:UntagDeliveryStream
              - acm:AddTagsToCertificate
              - acm:DeleteCertificate
              - acm:DescribeCertificate
              - acm:GetCertificate
              - acm:ListCertificates
              - acm:ListTagsForCertificate
              - acm:RemoveTagsFromCertificate
              - acm:RenewCertificate
              - acm:RequestCertificate
              - route53:ChangeResourceRecordSets
              - route53:GetHostedZone
              - route53:ListResourceRecordSets
              - route53:GetChange
              - secretsmanager:Create*
              - secretsmanager:Update*
              - secretsmanager:Delete*
              - secretsmanager:Describe*
              - secretsmanager:List*
              - secretsmanager:Tag*
              - secretsmanager:Untag*
              - secretsmanager:GetSecretValue
              - scheduler:GetSchedule
              - scheduler:CreateSchedule
              - scheduler:DeleteSchedule
              - scheduler:ListSchedules
              - scheduler:TagResource
              - scheduler:UntagResource
              - scheduler:UpdateSchedule
              - scheduler:ListTagsForResource
            Resource: "*"
  
  GrantCloudFormationExecutionAccessPolicyC:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Roles:
        - Ref: CloudFormationExecutionRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:CreateTable
              - dynamodb:DeleteTable
              - dynamodb:DescribeTable
              - dynamodb:UpdateTable
              - dynamodb:TagResource
              - dynamodb:UntagResource
              - dynamodb:ListTables
              - dynamodb:ListTagsOfResource
              - dynamodb:GetResourcePolicy
              - dynamodb:DescribeContributorInsights
              - dynamodb:DescribeContinuousBackups
              - dynamodb:DescribeKinesisStreamingDestination
              - dynamodb:DescribeTimeToLive
              - application-autoscaling:PutScalingPolicy
              - application-autoscaling:DeleteScalingPolicy
              - application-autoscaling:DescribeScalingPolicies
              - application-autoscaling:DescribeScalableTargets
              - application-autoscaling:RegisterScalableTarget
              - application-autoscaling:DeregisterScalableTarget
              - application-autoscaling:TagResource
              - application-autoscaling:UntagResource
              - application-autoscaling:ListTagsForResource
              - application-autoscaling:DescribeScheduledActions
              - states:CreateActivity
              - states:CreateStateMachine
              - states:CreateStateMachineAlias
              - states:DeleteActivity
              - states:DeleteStateMachine
              - states:DeleteStateMachineAlias
              - states:DeleteStateMachineVersion
              - states:DescribeActivity
              - states:DescribeExecution
              - states:DescribeMapRun
              - states:DescribeStateMachine
              - states:DescribeStateMachineAlias
              - states:DescribeStateMachineForExecution
              - states:ListActivities
              - states:ListStateMachineAliases
              - states:ListStateMachineVersions
              - states:ListStateMachines
              - states:ListTagsForResource
              - states:PublishStateMachineVersion
              - states:TagResource
              - states:UntagResource
              - states:UpdateMapRun
              - states:UpdateStateMachine
              - states:UpdateStateMachineAlias
              - ssm:GetParameters
              - ssm:PutParameter
              - ssm:DeleteParameter
              - ssm:AddTagsToResource
              - ssm:DescribeParameters
              - ssm:ListTagsForResource
              - ssm:RemoveTagsFromResource
              - cloudwatch:DescribeAlarms
              - cloudwatch:PutMetricAlarm
              - cloudwatch:DeleteAlarms
            Resource: "*"
  
  GrantCloudFormationExecutionEc2AccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Roles:
        - Ref: CloudFormationExecutionRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - ec2:CreateVpc
              - ec2:DeleteVpc
              - ec2:DescribeVpcs
              - ec2:ModifyVpcAttribute
              - ec2:DescribeVpcAttribute
              - ec2:AssociateVpcCidrBlock
              - ec2:DisassociateVpcCidrBlock
              - ec2:CreateVpcEndpoint
              - ec2:DeleteVpcEndpoints
              - ec2:ModifyVpcEndpoint
              - ec2:DescribeVpcEndpoints
              - ec2:CreateTags
              - ec2:DeleteTags
              - ec2:DescribeTags
              - ec2:CreateSubnet
              - ec2:DeleteSubnet
              - ec2:DescribeSubnets
              - ec2:ModifySubnetAttribute
              - ec2:AssociateSubnetCidrBlock
              - ec2:DisassociateSubnetCidrBlock
              - ec2:CreateSecurityGroup
              - ec2:DeleteSecurityGroup
              - ec2:DescribeSecurityGroups
              - ec2:DescribeStaleSecurityGroups
              - ec2:AuthorizeSecurityGroupEgress
              - ec2:AuthorizeSecurityGroupIngress
              - ec2:RevokeSecurityGroupEgress
              - ec2:RevokeSecurityGroupIngress
              - ec2:UpdateSecurityGroupRuleDescriptionsEgress
              - ec2:UpdateSecurityGroupRuleDescriptionsIngress
              - ec2:DescribeSecurityGroupReferences
              - ec2:ModifySecurityGroupRules
              - ec2:DescribeSecurityGroupRules
              - ec2:GetSecurityGroupsForVpc
              - ec2:CreateRouteTable
              - ec2:DeleteRouteTable
              - ec2:DescribeRouteTables
              - ec2:AssociateRouteTable
              - ec2:DisassociateRouteTable
              - ec2:ReplaceRouteTableAssociation
              - ec2:CreateRoute
              - ec2:DeleteRoute
              - ec2:ReplaceRoute
              - ec2:CreateNetworkInterface
              - ec2:DeleteNetworkInterface
              - ec2:AttachNetworkInterface
              - ec2:DetachNetworkInterface
              - ec2:DescribeNetworkInterfaces
              - ec2:ModifyNetworkInterfaceAttribute
              - ec2:ResetNetworkInterfaceAttribute
              - ec2:DescribeNetworkInterfaceAttribute
              - ec2:CreateNatGateway
              - ec2:DeleteNatGateway
              - ec2:DescribeNatGateways
              - ec2:AssociateNatGatewayAddress
              - ec2:DisassociateNatGatewayAddress
              - ec2:CreateInternetGateway
              - ec2:DeleteInternetGateway
              - ec2:AttachInternetGateway
              - ec2:DetachInternetGateway
              - ec2:DescribeInternetGateways
              - ec2:CreateEgressOnlyInternetGateway
              - ec2:DeleteEgressOnlyInternetGateway
              - ec2:DescribeEgressOnlyInternetGateways
              - ec2:AssignIpv6Address
              - ec2:UnassignIpv6Address
              - ec2:AllocateAddress
              - ec2:AssociateAddress
              - ec2:DisassociateAddress
              - ec2:ReleaseAddress
              - ec2:DescribeAddresses
              - ec2:ModifyAddressAttribute
              - ec2:ResetAddressAttribute
              - ec2:DescribeAddressesAttribute
              - ec2:DescribeAvailabilityZones
              - ec2:DescribeRegions
              - ec2:CreateFlowLogs
              - ec2:DeleteFlowLogs
              - ec2:DescribeFlowLogs
              - ecs:DescribeClusters
              - ecs:CreateCluster
              - ecs:TagResource
              - ecs:UntagResource
              - ecs:ListTagsForResource
              - ecs:DeleteCluster
            Resource: "*"

  ##################################################
  # Cloudformation Check Version Role
  ##################################################
  CloudFormationCheckVersionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Action:
              - sts:AssumeRoleWithWebIdentity
            Principal:
              Federated: !GetAtt GitHubIdentityProvider.Arn
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: sts.amazonaws.com
              ForAnyValue:StringLike:
                token.actions.githubusercontent.com:sub: !Ref CheckVersionSubjectClaimFilters

  DescribeCloudFormationStackPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Roles:
        - Ref: CloudFormationCheckVersionRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - cloudformation:DescribeStacks
              - cloudformation:ListExports
              - cloudformation:ListStacks
            Resource: "*"

  ##################################################
  # Cloudformation Prepare Changeset Role
  ##################################################
  CloudFormationPrepareChangesetRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Action:
              - sts:AssumeRoleWithWebIdentity
            Principal:
              Federated: !GetAtt GitHubIdentityProvider.Arn
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: sts.amazonaws.com
              ForAnyValue:StringLike:
                token.actions.githubusercontent.com:sub: !Ref PrepareChangesetClaimFilters

  CreateCloudFormationStackChangeSetPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Roles:
        - Ref: CloudFormationPrepareChangesetRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - cloudformation:DescribeStacks
              - cloudformation:ListExports
              - cloudformation:CreateChangeSet
              - cloudformation:DescribeChangeSet
              - cloudformation:DescribeStackEvents
              - cloudformation:GetTemplateSummary
              - cloudformation:ListStacks
              - cloudformation:DeleteChangeSet
            Resource: "*"

  ##################################################
  # Release Notes Role
  ##################################################
  ReleaseNotesExecuteLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Action:
              - sts:AssumeRoleWithWebIdentity
            Principal:
              Federated: !GetAtt GitHubIdentityProvider.Arn
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: sts.amazonaws.com
              ForAnyValue:StringLike:
                token.actions.githubusercontent.com:sub: !Ref ReleaseNotesExecuteLambdaClaimFilters

  ##################################################
  # Artillery.io runner Role
  ##################################################
  ArtilleryRunnerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Action:
              - sts:AssumeRoleWithWebIdentity
            Principal:
              Federated: !GetAtt GitHubIdentityProvider.Arn
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: sts.amazonaws.com
              ForAnyValue:StringLike:
                token.actions.githubusercontent.com:sub: !Ref ArtilleryLoadTestRoleClaimFilters

  ArtilleryRunnerPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Roles:
        - Ref: ArtilleryRunnerRole
      PolicyDocument:
        Version: "2012-10-17"
        Statement: 
          - Effect: "Allow"
            Action:
              - "iam:PassRole"
              - "iam:GetRole"
            Resource: 
              - !Sub "arn:aws:iam::${AWS::AccountId}:role/artilleryio-ecs-worker-role"
          - Sid: "SQSPermissions"
            Effect: "Allow"
            Action: 
              - "sqs:*"
            Resource: !Sub "arn:aws:sqs:*:${AWS::AccountId}:artilleryio*"
          - Sid: "SQSListQueues"
            Effect: "Allow"
            Action: 
              - "sqs:ListQueues"
            Resource: "*"
          - Sid: "ECSPermissionsGeneral"
            Effect: "Allow"
            Action: 
              - "ecs:ListClusters"
              - "ecs:RegisterTaskDefinition"
              - "ecs:DeregisterTaskDefinition"
              - "ecs:DescribeTaskDefinition"
            Resource: "*"
          - Sid: "ECSPermissionsScopedToCluster"
            Effect: "Allow"
            Action: 
              - "ecs:DescribeClusters"
              - "ecs:ListContainerInstances"
            Resource: !Sub "arn:aws:ecs:*:${AWS::AccountId}:cluster/*"
          - Sid: "ECSPermissionsScopedWithCondition"
            Effect: "Allow"
            Action: 
              - "ecs:SubmitTaskStateChange"
              - "ecs:DescribeTasks"
              - "ecs:ListTasks"
              - "ecs:ListTaskDefinitions"
              - "ecs:DescribeTaskDefinition"
              - "ecs:StartTask"
              - "ecs:StopTask"
              - "ecs:RunTask"
            Condition: 
              ArnEquals: 
                ecs:cluster: !Sub "arn:aws:ecs:*:${AWS::AccountId}:cluster/*"
            Resource: "*"
          - Sid: "S3Permissions"
            Effect: "Allow"
            Action:
              - "s3:DeleteObject"
              - "s3:GetObject"
              - "s3:GetObjectAcl"
              - "s3:GetObjectTagging"
              - "s3:GetObjectVersion"
              - "s3:PutObject"
              - "s3:PutObjectAcl"
              - "s3:ListBucket"
              - "s3:GetBucketLocation"
              - "s3:GetBucketLogging"
              - "s3:GetBucketPolicy"
              - "s3:GetBucketTagging"
              - "s3:PutBucketPolicy"
              - "s3:PutBucketTagging"
              - "s3:PutMetricsConfiguration"
              - "s3:GetLifecycleConfiguration"
              - "s3:PutLifecycleConfiguration"
            Resource: 
              - !Sub "arn:aws:s3:::artilleryio-test-data-${AWS::AccountId}"
              - !Sub "arn:aws:s3:::artilleryio-test-data-${AWS::AccountId}/*"
          - Effect: "Allow"
            Action: 
              - "secretsmanager:GetSecretValue"
            Resource: 
              - !Sub "arn:aws:secretsmanager:*:${AWS::AccountId}:secret:artilleryio/*"
          - Effect: "Allow"
            Action: 
              - "ssm:PutParameter"
              - "ssm:GetParameter"
              - "ssm:GetParameters"
              - "ssm:DeleteParameter"
              - "ssm:DescribeParameters"
              - "ssm:GetParametersByPath"
            Resource: 
              - !Sub "arn:aws:ssm:eu-west-2:${AWS::AccountId}:parameter/artilleryio/*"
          - Effect: "Allow"
            Action: 
              - "ec2:DescribeRouteTables"
              - "ec2:DescribeVpcs"
              - "ec2:DescribeSubnets"
            Resource: 
              - "*"
          - Effect: Allow
            Action:
              - cloudformation:ListExports
            Resource: "*"
          - Effect: Allow
            Action:
              - logs:PutRetentionPolicy
            Resource: 
              - !Sub "arn:aws:logs:eu-west-2:${AWS::AccountId}:log-group:artilleryio-log-group/*"

Outputs:
  ##################################################
  # Cloudformation Deployment Role Outputs
  ##################################################
  CloudFormationDeployRole:
    Description: ARN of the IAM Role(CloudFormationDeployRole)
    Value: !GetAtt CloudFormationDeployRole.Arn
    Export:
      Name: !Join [":", [!Ref "AWS::StackName", "CloudFormationDeployRole"]]

  CloudFormationDeployRoleName:
    Description: Name of the IAM Role(CloudFormationDeployRole)
    Value: !Ref CloudFormationDeployRole
    Export:
      Name: !Join [":", [!Ref "AWS::StackName", "CloudFormationDeployRoleName"]]

  ##################################################
  # Cloudformation Execution Role Outputs
  ##################################################
  CloudFormationExecutionRole:
    Description: ARN of the IAM Role(CloudFormationExecutionRole)
    Value: !GetAtt CloudFormationExecutionRole.Arn
    Export:
      Name: !Join [":", [!Ref "AWS::StackName", "CloudFormationExecutionRole"]]

  CloudFormationExecutionRoleName:
    Description: Name of the IAM Role(CloudFormationExecutionRole)
    Value: !Ref CloudFormationExecutionRole
    Export:
      Name:
        !Join [":", [!Ref "AWS::StackName", "CloudFormationExecutionRoleName"]]

  ##################################################
  # Cloudformation Check Version Role Outputs
  ##################################################
  CloudFormationCheckVersionRole:
    Description: ARN of the IAM Role(CloudFormationCheckVersionRole)
    Value: !GetAtt CloudFormationCheckVersionRole.Arn
    Export:
      Name:
        !Join [":", [!Ref "AWS::StackName", "CloudFormationCheckVersionRole"]]

  CloudFormationCheckVersionRoleName:
    Description: Name of the IAM Role(CloudFormationCheckVersionRole)
    Value: !Ref CloudFormationCheckVersionRole
    Export:
      Name:
        !Join [
          ":",
          [!Ref "AWS::StackName", "CloudFormationCheckVersionRoleName"],
        ]

  ##################################################
  # Cloudformation Prepare Changeset Role Outputs
  ##################################################
  CloudFormationPrepareChangesetRole:
    Description: ARN of the IAM Role(CloudFormationPrepareChangesetRole)
    Value: !GetAtt CloudFormationPrepareChangesetRole.Arn
    Export:
      Name:
        !Join [
          ":",
          [!Ref "AWS::StackName", "CloudFormationPrepareChangesetRole"],
        ]

  CloudFormationPrepareChangesetName:
    Description: Name of the IAM Role(CloudFormationPrepareChangesetRole)
    Value: !Ref CloudFormationPrepareChangesetRole
    Export:
      Name:
        !Join [
          ":",
          [!Ref "AWS::StackName", "CloudFormationPrepareChangesetRoleName"],
        ]
  ##################################################
  # Release Notes Role Outputs
  ##################################################
  ReleaseNotesExecuteLambdaRole:
    Description: ARN of the IAM Role(ReleaseNotesExecuteLambdaRole)
    Value: !GetAtt ReleaseNotesExecuteLambdaRole.Arn
    Export:
      Name:
        !Join [":", [!Ref "AWS::StackName", "ReleaseNotesExecuteLambdaRole"]]
  ReleaseNotesExecuteLambdaName:
    Description: Name of the IAM Role(ReleaseNotesExecuteLambda)
    Value: !Ref ReleaseNotesExecuteLambdaRole
    Export:
      Name:
        !Join [
          ":",
          [!Ref "AWS::StackName", "ReleaseNotesExecuteLambdaRoleName"],
        ]
  ##################################################
  # Artillery Runner Role Outputs
  ##################################################
  ArtilleryRunnerRole:
    Description: ARN of the IAM Role(ArtilleryRunnerRole)
    Value: !GetAtt ArtilleryRunnerRole.Arn
    Export:
      Name:
        !Join [":", [!Ref "AWS::StackName", "ArtilleryRunnerRole"]]
  ArtilleryRunnerRoleName:
    Description: Name of the IAM Role(ArtilleryRunnerRole)
    Value: !Ref ArtilleryRunnerRole
    Export:
      Name:
        !Join [
          ":",
          [!Ref "AWS::StackName", "ArtilleryRunnerRoleName"],
        ]
